---
title: "ARMA and ARIMA Models"
---

ARMA and ARIMA Models are used in time-series in order to forecast the time series object at had. Thus, we will take a look at both the globalization index as well as the stock fluctuation of HYBE Co. in order to forecast values and make future predictions. These metrics will help us determine the impact globalization in conjunction with record labels like HYBE have within the United States and the Western music world. 

## Globalization Index: 
From our [Exploratory Data Analysis](https://shriya-chinthak.georgetown.domains/DSAN_5600/eda.html), we noticed the following information: 

* Prior to differncing, the ACF plot show several lags above the significance bands, indicating a **non-stationary** relationship. 
* The Augmented Dickey-Fuller Test confirmed that the data itself was **NOT stationary**.

Thus, using this information, we will move on to differencing to fit the data to become stationary: 
```{r}
#| echo: false
#| warning: false
library(tidyverse)
library(ggplot2)
library(forecast)
library(astsa) 
library(xts)
library(tseries)
library(fpp2)
library(fma)
library(lubridate)
library(tidyverse)
library(TSstudio)
library(quantmod)
library(tidyquant)
library(plotly)
library(ggplot2)
library(imputeTS)
library(gridExtra)
library(reticulate)
library(readxl)
use_python("/usr/local/bin/python3", require = T)
knitr::knit_engines$set(python = reticulate::eng_python)
```

```{r}
#| echo: false
#| warning: false
global <- read_csv('globalization.csv')

# Filter information
global <- global %>%
  filter(country == 'United States') %>%
  select(year, KOFGI) %>%
  mutate(year = as.Date(year))

# Create time series
global_ts <-ts(global$KOFGI, star=decimal_date(as.Date("1970-01-01", format = "%Y-%m-%d")), frequency = 1)
```

```{r}
#| code-fold: true
#| code-summary: 'Differencing Code'
#| warning: false

dff_global <- diff(global_ts)
p1 <- ggAcf(dff_global)+ggtitle("ACF Plot for First Differenced Globalization Index")
p2 <- ggPacf(dff_global)+ggtitle("PACF Plot for First Differenced Globalization Index")

grid.arrange(p1, p2, nrow=2)
```

From the ACF and PACF plots of the first differenced time series object, we can now see that lag values are all contained inside the significance bands, meaning that this distribution is in fact, **stationary**. 

Let's see the Augumented Dickey-Fuller score for the first differenced data: 
```{r}
#| warning: false
#| echo: false
diff_global_test <- adf.test(dff_global)
print(diff_global_test)
```

Unfortunetly, since the ADF p-value is 0.09043 > 0.05, we fail to reject the null hypothesis. From teh ADF test, the distribution is still stationary. However, because this score is not allows accurate, we will assume the results of the ACF plots are correct to avoid over-differencing. 

Thus from the plot, we can also state the following: 

* Since the ACF plot doesn't have any significant peaks, **q = 0**. 

* Since the PACF plot doesn't have any significant peaks, **p = 0**. 

* Since we differenced once, **d = 1**.

While q and p are zero based on the graph, it's better to run through a multitude of options in order to find the best model for this data.

Now, let's move to creating the ARIMA model:
```{r}
#| code-fold: true 
#| code-summary: 'ARIMA Model'
#| warning: false

set.seed(123)

d=1
i=1
temp= data.frame()
ls=matrix(rep(NA,6*25),nrow=25) # roughly nrow = 5x2 (see below)


for (p in 0:4)# p=0,1,2,3,4 : 5
{
  for(q in 0:4)# q=0,1,2,3,4 :5
  {
    model<- Arima(dff_global,order=c(p,d,q),include.drift=TRUE) 
    ls[i,]= c(p,d,q,model$aic,model$bic,model$aicc)
    i=i+1
  }
}

temp= as.data.frame(ls)
names(temp)= c("p","d","q","AIC","BIC","AICc")

#temp
knitr::kable(temp)
```

Thus, we can easily view that the best model has values **p=0, d=1, and q=1**. Let's find the equation

```{r}
#| code-fold: true
sarima(dff_global, 0, 1, 1)
```

From the results of the `sarima()` function, we call say that the equation is as follows:

\begin{align}
x_{t} = w_{t} -1w_{t-1} - 0.0136
\end{align}

From the model diagonotics presented, we can also say that the ACF plot of residuals shows no significance, meaning the residuals are not correlated. However, the p-values of the Ljung-Box statistic is much higher than the significance band. While this is not *great*, we can still move forward since the residuals are not significant and that this was the best model of the ones simulated. 

Now let's varify with auto arima:
```{r}
#| echo: false
auto.arima(dff_global)
```

`auto.arima()` also chose the same model I concluded with, thus we will continue with this model. 

Now let's look at the forecast: 

First, let's forecast based on the best model 

```{r}
#| code-fold: true 
#| code-summary: 'Forecasting'
#| warning: false
fit <- Arima(dff_global, order=c(0, 1, 1))
autoplot(forecast(fit))
```

From the looks of the forecast, we can see a very large confidence band with the values mostly following the overal trend of the differenced data. Let's compare to the naive approaches:

```{r}
#| code-fold: true 
#| code-summary: 'Forecast comparison'
#| warning: false
summary(fit)

autoplot(dff_global) +
  autolayer(meanf(dff_global, h=11),
            series="Mean", PI=FALSE) +
  autolayer(naive(dff_global, h=11),
            series="Naïve", PI=FALSE) +
  autolayer(snaive(dff_global, h=11),
            series="Seasonal naïve", PI=FALSE) +
  autolayer(forecast(fit, h=11),
            series="Fit", PI=FALSE) +
  ggtitle("Forecasts for yearly globalization metric") +
  xlab("Year") + ylab("KOF Index") +
  guides(colour=guide_legend(title="Forecast"))
```

After mapping the model with other benchmarks, it's clear that none of the functions, fitted or benchmarks, accurately forecasts the differenced data. The fitted data seems to the only line approximately in the same range as the overall trend, however, none of them are accurate functions. As a result of this information, it may be worth taking a look at this data un-differenced in order to get a better insight of the globalization index. 

# SARIMA Model:

In order to understand globalization within the USA through the lens on South Korea, we will need to also look at the tourism coming into SK from abroad. An example of this is using monthly air travel passeneger data into Incheon Airport, South Korea's largest international airport. Specifically, we'll be focusing on international flights coming into South Korea as they best represent foreign interest of the nation. 

### Seasonal Anlysis
```{r}
#| warning: false
#| code-fold: true


sk_passengers <- read_xlsx('sk_passenger_arrivals.xlsx')

sk_passengers <- sk_passengers %>%
  unite(date, year, month, sep = '-') %>%
  mutate(date = as.Date(paste(date, '01', sep = '-'))) %>%
  filter(year(date) < 2020) #In order to avoid the anomaly of the 2020 pandemic

air_travel_ts <- ts(sk_passengers$Passengers, start = c(2010, 10), 
                    frequency = 12)

autoplot(air_travel_ts)+ggtitle("Air passenger arrivals to Incheon Airport (SK)") 

```

From the plot above, we can see that there is a seasonal pattern of passengers coming into the country yearly. Please note that to avoid anomalies in forecasting, we'll not be training on 2020 data due to the restrictions on travel from the COVID-19 global pandemic. 

```{r}
ggAcf(air_travel_ts,40)
gglagplot(air_travel_ts, do.lines=FALSE, set.lags = c(12, 24, 36, 48))+
  ggtitle("Air passenger arrivals to Incheon Airport (SK)") 
dec2 <- decompose(air_travel_ts,type = c("additive", "multiplicative"))
plot(dec2)
```

Through these graphs, we can see a string seasonal correlation. However, since the data is mutliplicative in nature, we may need to take the log of the data prior to differencing. 

```{r}
#| code-fold: true

log(air_travel_ts) %>% diff() %>% ggtsdisplay()
log(air_travel_ts) %>% diff(12) %>% ggtsdisplay()
log(air_travel_ts) %>% diff() %>% diff(12) %>% ggtsdisplay()
```

From the ACF and PACF plots, we can see that the data is the most stationary when the original data is log transformed, first differenced, and seasonally differenced by month. From these plots, we can say that q = 2, p = 2,4, d = 1, Q = 1, and P = 1. 

In order to find the best model, we'll run through mutliple models and find the ones with the lowest AIC and BIC score. 

### Determining the Model

```{r}
#| code-fold: true

#write a function
SARIMA.c=function(p1,p2,q1,q2,P1,P2,Q1,Q2,data){
  
  temp=c()
  d=1
  D=1
  s=12
  
  i=1
  temp= data.frame()
  ls=matrix(rep(NA,9*35),nrow=35)
  for (p in p1:p2)
  {
    for(q in q1:q2)
    {
      for(P in P1:P2)
      {
        for(Q in Q1:Q2)
        {
          if(p+d+q+P+D+Q<=9)
          {
            model<- Arima(data,order=c(p-1,d,q-1),seasonal=c(P-1,D,Q-1))
            ls[i,]= c(p-1,d,q-1,P-1,D,Q-1,model$aic,model$bic,model$aicc)
            i=i+1
          }
        }
      }
    }
  }
  
  temp= as.data.frame(ls)
  names(temp)= c("p","d","q","P","D","Q","AIC","BIC","AICc")
  temp
}

output=SARIMA.c(p1=1,p2=5,q1=1,q2=3,P1=1,P2=3,Q1=1,Q2=3,data=air_travel_ts)
knitr::kable(output)

output[which.min(output$AIC),]
output[which.min(output$BIC),]
output[which.min(output$AICc),]
```

Based on the AIC, BIC, and AICc values, we'll go forward with the model ARIMA(0,1,2)x(0,1,1)[12]. Let's analyze this model for it's residuals and siginificant values.

```{r}
#| code-fold: true

set.seed(123)
model_output <- capture.output(sarima(air_travel_ts, 0,1,2,0,1,1,12))
cat(model_output[28:60], model_output[length(model_output)], sep = "\n") 
```

This model seems to be a goof fit for a number of reasons. Primarily, the ACF plot shows almost no correlation, indicating that the model has harnessed everything that left is white noise. This indicates a good model fit. Additionally, the Ljung-Box statistic shows almost no autocorrelation within the model. Lastly, all coefficients within the table are significant. 

### Fitting the Model and Forecasting

```{r}
#| code-fold: true

fit <- Arima(air_travel_ts, order=c(0,1,2), seasonal=c(0,1,1))
summary(fit)
```


```{r}
#| echo: false
sarima.for(air_travel_ts, 60, 0,1,2,0,1,1,12)
```

Our forecast shows a positive upwards trend in international passenger arrivals into Incheon Airport, South Korea. Please note, this forecast shows five years into the future if the COVID-19 pandemic didn't cause any anomalies within air travel. However, even knowing that the actual data isn't the same, we can approximate that the travel industry would recover in a similar pattern, with a positive trend of people coming into Korea. Thus, this furthers the narrative of globalization, and specifically, Korean culture reaching outside its country's borders into the West. 


